---
layout: post
title: FORTH a procesor J1
author: Martin Malý
permalink: /j1-2/
categories: [j1]
---

## Implementace J1 ve Verilogu

> Kapitola z knihy [Data, čipy, procesory](https://datacipy.cz)

Začneme společnými definicemi. Vytvoříme soubor common.h, který budeme později vkládat, kde bude zapotřebí.

```
`default_nettype none
`define WIDTH 16  -- Autor upravil i pro 32 bitů
`define DEPTH 4
```

Procesor obsahuje dva zásobníky, a protože jsou to reálné paměťové struktury, pojďme si je nadeklarovat jako moduly:

```
`include "common.h"

module stack
  #(parameter DEPTH=4)
  (input wire clk,
  /* verilator lint_off UNUSED */
  input wire resetq,
  /* verilator lint_on UNUSED */
  input wire [DEPTH-1:0] ra,
  output wire [`WIDTH-1:0] rd,
  input wire we,
  input wire [DEPTH-1:0] wa,
  input wire [`WIDTH-1:0] wd);

  reg [`WIDTH-1:0] store[0:(2**DEPTH)-1];

  always @(posedge clk)
    if (we)
      store[wa] <= wd;

  assign rd = store[ra];
endmodule
```

Modul je parametrizovaný jedním parametrem, DEPTH (defaultní hodnota je 4). Pa-rametr udává počet bitů adresy, tedy položek na zásobníku (těch je 2DEPTH). Předna-stavená hodnota 4 tedy znamená, že zásobník je pro 16 položek.  Zásobník má dvě adresní sběrnice a dvě datové sběrnice – jeden pár pro čtení, jeden pro zápis. Vstup we (Write Enable) povoluje zápis – pokud je aktivní, zásobník zapíše hodnotu z datového vstupu wd na adresu ze vstupu wa. Na výstupu rd je stále obsah paměti z adresy ra.
Zásobník sám o sobě neobsahuje žádnou další logiku, která by se starala o ukazatel, o jeho zvyšování a snižování a o podobné činnosti.

A takhle vypadá [celá implementace procesoru, jak ji publikoval autor James Bowman](https://github.com/jamesbowman/j1)

Dovolím si ji okomentovat a zdůraznit zajímavé pasáže:

```
`include "common.h"

module j1(
   input wire clk,
   input wire resetq,

   output wire io_wr,
   output wire [15:0] mem_addr,
   output wire mem_wr,
   output wire [`WIDTH-1:0] dout,
   input  wire [`WIDTH-1:0] mem_din,

   input  wire [`WIDTH-1:0] io_din,
   output wire [12:0] code_addr,
   input  wire [15:0] insn
   );
```
